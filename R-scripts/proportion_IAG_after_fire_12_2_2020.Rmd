---
title: "upper beaver"
author: "Claire Tortorelli"
date: "January 2, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(lme4)
library(emmeans)

```

```{r read in data}

df <- read.csv(here("raw-data/ubdata_16-20_species_average.csv"))

#convert back to number of hits for modeling 
ub_veg <- df[6:114] * 40/100
ub_veg <- cbind(df[1:5], ub_veg)
```



Organize species data
```{r}
#add  IAG col
ub_veg$IAG <- ub_veg$VEDU + ub_veg$BRJA + ub_veg$BRTE

#add CANOPY col
ub_veg$CANOPY <- ub_veg$PIPO + ub_veg$PSME + ub_veg$JUOC

#add all veg col
ub_veg$all_veg <- rowSums(ub_veg[,6:114])

#non IAG col
ub_veg$all_veg_woIAG <- ub_veg$all_veg - ub_veg$IAG

#all veg without the canopy and without IAG
ub_veg$veg.noiag.nocanopy <- ub_veg$all_veg_woIAG - ub_veg$CANOPY

#all veg without canopy cover
ub_veg$all_veg.nocanopy <- ub_veg$all_veg - ub_veg$CANOPY

#add proportion IAG col (out of understory veg)
ub_veg$prop.IAG <- ub_veg$IAG/ub_veg$all_veg.nocanopy
```

Organize non-veg factors
```{r}
#change year to factor
ub_veg$YEAR <- as.factor(ub_veg$YEAR)

# combine unburned and c_unburned 
ub_veg$burn2 <- ub_veg$BURN17
ub_veg$burn2[ub_veg$burn2=="c_unburned"] <- "unburned"

#redefine levels for burn17
ub_veg$burn2 <- factor(ub_veg$burn2,
levels = c("unburned", "<50", ">50") )
```


```{R}
#organize data so that prefire IG cover has its own column

ubiag_postfire <- subset(ub_veg, YEAR != '16')
ubiag_prefire <- subset(ub_veg, YEAR == '16')


ubiag_prefire$IAG_prefire <- ubiag_prefire$IAG
ubiag_prefire$all_veg.nocanopy_prefire <- ubiag_prefire$all_veg.nocanopy

ubiag_prefiresub <- ubiag_prefire[c("PLOT", "IAG_prefire", "all_veg.nocanopy_prefire")]

#merge prefire and post fire dataframes
ub_merge <- merge(ubiag_postfire, ubiag_prefiresub, by = "PLOT")
```


model proportion of IAG to total non canopy vegetation
```{r}
hist(ub_merge$prop.IAG) 

qplot(burn2, prop.IAG, data = ub_veg)

# give our response as both the number of successes and failures (IAG and all_veg-IAG)

(gm1 <- glmer(cbind(IAG, all_veg.nocanopy - IAG) ~ burn2*YEAR + IAG_prefire + (1 | PLOT),
              data = ub_merge, family = binomial))

#fit with a different optimizer to allow convergence
ss <- getME(gm1,c("theta","fixef"))
gm2 <- update(gm1,start=ss,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

#check for overdispersion
plot(gm2) 
sum( residuals(gm2, type = "pearson")^2 )/100 #100 = df.resid
#dispersion = 0.56, not too shabby

qplot(fitted(gm2), resid(gm2) ) +
theme_bw() +
labs(x = "Fitted",
y = "Deviance Residuals") 

deviance(gm2)/df.residual(gm2) 
#low overdispersion

summary(gm2)

#Wald Chi-square for interaction effect
library(car)
Anova(gm1)
```


```{r}
#use trt.vs.ctrl to compare all groups to reference level (unburned)
(emmeans(gm1, specs = trt.vs.ctrl ~ burn2*YEAR  + IAG_prefire, adjust = NULL))

#all comparisons
(emmeans(gm1, specs = revpairwise ~ burn2 | YEAR  + IAG_prefire, adjust = NULL))


```
strong effect of pre-fire IAG, positive effect of year 20 and some negative effect of high severity. No evidence of interaction, although negative effect of burning seems to decrease with time after fire


```{r fig.height=4, fig.width=3.5}
#plot raw data with standard errors
#summarize data
library(Rmisc)
#ventenata
iagsum <- summarySE(ub_veg, measurevar="prop.IAG", groupvars=c("burn2","YEAR"))
levels(iagsum$burn2) <- list("unburned" = "unburned", "low severity" = "<50", "high severity" = ">50")
levels(iagsum$YEAR) <- list("2016" = "16", "2018" = "18", "2019" = "19", "2020" = "20")

rawiagprop <- ggplot(iagsum, aes(x = as.integer(as.character(YEAR)), y = prop.IAG, group = burn2, color = burn2) ) + 
		geom_line(position = position_dodge(0.2))+
		geom_point(size = 3.2, position = position_dodge(0.2)) + # Add points
  geom_errorbar(aes(ymin = prop.IAG - se, ymax = prop.IAG + se), width = .5, alpha = 0.5, size = 1, position = position_dodge(0.2))+
		labs(x = NULL, y = "IAG:total cover") + # Label axes
		theme_bw(base_size = 14) + # Make black and white,
								# increase base text size
			 theme(panel.grid.major.x = element_blank())+ # Remove y gridlines
			         scale_color_manual(values = c("#52796f", "#dda15e", "#bc6c25"))+
  theme(legend.position = "bottom")+ 
  theme(legend.title = element_blank()) +
  geom_vline(xintercept = 2017, colour = "dark grey", lty = 2)+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())


rawiagprop
#ggsave("propIAGraw.svg")
```


probably not  using anything after this....
--------------------------


model total IAG after burning accounting for pre-fire IAG
```{R total IAG}

(m2 <- glmer.nb(IAG ~ burn2*YEAR + IAG_prefire + (1 | PLOT), 
              data = ub_merge))
plot(m2)

qplot(fitted(m2), resid(m2) ) +
theme_bw() +
labs(x = "Fitted",
y = "Deviance Residuals") #low overdispersion


summary(m2)
Anova(m2, type =3)

library(sjPlot)
plot_model(m2, type = "int")
```


```{r}
emm2 <- emmeans(m2, specs = trt.vs.ctrl ~ burn2*YEAR, type = "response")


```

burning had a negative effect on IAG, but this effect increased with time... Year 20 had a large positive effect on IAG. 

```{r fig.height=4, fig.width=4}
ub_veg$IAG_cover <- ub_veg$IAG/40*100
iagtot <- summarySE(ub_veg, measurevar="IAG_cover", groupvars=c("burn2","YEAR"))

rawiagtot <- ggplot(iagtot, aes(x = as.integer(as.character(YEAR)), y = IAG_cover, group = burn2, color = burn2) ) + 
		geom_line(position = position_dodge(0.2))+
		geom_point(size = 3.2, position = position_dodge(0.2)) + # Add points
  geom_errorbar(aes(ymin = IAG_cover - se, ymax = IAG_cover + se), width = .2, alpha = 0.5, position = position_dodge(0.2))+
		labs(x = NULL, y = "mean IAG cover(%)") + # Label axes
		theme_bw(base_size = 14) + # Make black and white,
								# increase base text size
			 theme(panel.grid.major.x = element_blank())+ # Remove y gridlines
			         scale_color_manual(values = c("#52796f", "#dda15e", "#bc6c25"))+
  theme(legend.position = "bottom")+ 
  theme(legend.title = element_blank()) +
  ggtitle("total IAG cover")+
  geom_vline(xintercept = 17, colour = "orangered4", lty = 2)+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())


rawiagtot

```
This may be misleading because multiple annual grasses could have been tallied at a single point..

