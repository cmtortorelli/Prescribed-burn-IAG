---
title: "upper beaver"
author: "Claire Tortorelli"
date: "January 2, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(MASS)
library(nlme)
library(emmeans)
library(tidyverse)
library(sjPlot)
library(car)
```

```{r read in data}

ubveg_iag <- read.csv(here("raw-data", "ubdata_16-20_species_tally.csv"))

```

```{r}

#change year to factor
ubveg_iag$YEAR <- as.factor(ubveg_iag$YEAR)
```



```{r}
#combine control unburned and uburned plots for one unburned category
ubveg_iag[ubveg_iag=="c_unburned"] <- "unburned"

#redefine levels for burn17
ubveg_iag$BURN17 <- factor(ubveg_iag$BURN17,
levels = c("unburned", "<50", ">50") )

```

model change since fire with pre-fire ventenata and brome as baseline
```{R}
#separate pre-fire data from post-fire data

ubiag_postfire <- subset(ubveg_iag, YEAR != '16')
ubiag_prefire <- subset(ubveg_iag, YEAR == '16')


ubiag_prefire$VEDU80_prefire <- ubiag_prefire$VEDU80
ubiag_prefire$BRTE80_prefire <- ubiag_prefire$BRTE80
ubiag_prefire$BRJA80_prefire <- ubiag_prefire$BRJA80

ubiag_prefiresub <- ubiag_prefire[c("PLOT", "VEDU80_prefire", "BRTE80_prefire", "BRJA80_prefire")]

#merge prefire and post fire dataframes
ubiag_merge <- merge(ubiag_postfire, ubiag_prefiresub, by = "PLOT")

```


```{r}
df20 <- filter(ubiag_merge, YEAR == '20')
df19 <- filter(ubiag_merge, YEAR == '19')
plot(df20$VEDU80 ~ df20$VEDU80_prefire, col = df20$BURN17)

lmvd <- lm(VEDU80 ~ VEDU80_prefire, data = df20)
lmbt <- lm(BRTE80 ~ BRTE80_prefire, data = df20)
lmbj <- lm(BRJA80 ~ BRJA80_prefire, data = df20)

summary(lmvd)
summary(lmbt)
summary(lmbj)

plot(lmvd)
plot(lmbt)
plot(lmbj)
```



model IAGs separately using binomial generalized linear mixed models (logistic regression)
```{r}
library(lme4)
#https://aosmith.rbind.io/2020/08/20/simulate-binomial-glmm/

(m.vd <- glmer(cbind(VEDU80, 80 - VEDU80) ~ BURN17*YEAR + VEDU80_prefire + (1 | PLOT), data = ubiag_merge, family = binomial))

(m.bt <- glmer(cbind(BRTE80, 80 - BRTE80) ~ BURN17*YEAR + BRTE80_prefire +(1 | PLOT), data = ubiag_merge, family = binomial))
m.bt2 <- update(m.bt, control = glmerControl(optimizer="bobyqa")) ##trouble converging..fit with a different optimizer 

(m.bj <- glmer(cbind(BRJA80, 80 - BRJA80) ~ BURN17*YEAR + BRJA80_prefire +(1 | PLOT), data = ubiag_merge, family = binomial))
m.bj2 <- update(m.bj, control = glmerControl(optimizer="bobyqa"))


#check for overdispersion - f the ratio considerably larger than 1, then it indicates that we have an overdispersion issue.
deviance(m.vd)/df.residual(m.vd) 
deviance(m.bt2)/df.residual(m.bt2) 
deviance(m.bj2)/df.residual(m.bj2) 

#looks good!
```

explore model results
```{r}
#examine results
summary(m.vd)
emmeans(m.vd, revpairwise ~ BURN17 + VEDU80_prefire, adjust = NULL)
emvd <- emmeans(m.vd, trt.vs.ctrl ~ BURN17 | YEAR + VEDU80_prefire, adjust = NULL)
Anova(m.vd)

summary(m.bt2)
embt <- emmeans(m.bt2, trt.vs.ctrl ~ BURN17 | YEAR + BRTE80_prefire, adjust = NULL)
Anova(m.bt2)

summary(m.bj2)
embj <- emmeans(m.bj2, trt.vs.ctrl ~ BURN17 | YEAR + BRJA80_prefire, adjust = NULL)
Anova(m.bj2)

```

### Plot contrasts
```{r}
#extract contrasts to table for each species
emvd2 <- emvd$contrasts %>%
     confint() %>% rbind()
embt2 <- embt$contrasts %>%
     confint() %>% rbind()
embj2 <- embj$contrasts %>%
     confint() %>% rbind()
```

ggplot
```{r}
plotcontrast <- function(df){
 p <-  ggplot(df, aes(x = YEAR, y = estimate, group = contrast, color = contrast) ) + 
		geom_point(size = 3.2, position = position_dodge(0.2)) + # Add points
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = .5, alpha = 0.5, size = 1, position = position_dodge(0.2)) +
		labs(x = NULL, y = "difference in log-odds") + # Label axes
		theme_bw(base_size = 15) + # Make black and white,
								# increase base text size
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
	geom_hline(yintercept = 0, colour = "dark grey", lty = 2) +
	scale_color_manual(values = c("grey", "black"))+
  theme(legend.title = element_blank()) +
  ylim(min = -5, max = 3)

 return(p)
}


```

plot contrasts
```{r}
vcontrast <- plotcontrast(emvd2) +  theme(legend.position = "bottom")
#pre-fire VD hits 5.76 = 7.2% cover

btcontrast <- plotcontrast(embt2) +  theme(legend.position = "NULL") + ylab("")
#pre-fire bt hits - 4.05 = 5.06 % cover

bjcontrast <- plotcontrast(embj2) +  theme(legend.position = "NULL") + ylab("")
#prefire bj hits - 3.11 = 3.89 % cover

```

### Plot raw data
```{r}
#plot raw data with standard errors
#summarize data
library(Rmisc)
library(cowplot)
library(ggpubr)

ubveg_iag$VEDU_perc <- ubveg_iag$VEDU80/80*100
ubveg_iag$BRTE_perc <- ubveg_iag$BRTE80/80*100
ubveg_iag$BRJA_perc <- ubveg_iag$BRJA80/80*100

ubveg_iag$YEAR2 <- ubveg_iag$YEAR
ubveg_iag$BURN2 <- ubveg_iag$BURN17
levels(ubveg_iag$BURN2) <- list("unburned" = "unburned", "low severity" = "<50", "high severity" = ">50")
levels(ubveg_iag$YEAR2) <- list("2016" = "16", "2018" = "18", "2019" = "19", "2020" = "20")
#ventenata
vdsum <- summarySE(ubveg_iag, measurevar="VEDU_perc", groupvars=c("BURN2","YEAR2"))
#brte
btsum <- summarySE(ubveg_iag, measurevar="BRTE_perc", groupvars=c("BURN2","YEAR2"))
#brja
bjsum <- summarySE(ubveg_iag, measurevar="BRJA_perc", groupvars=c("BURN2","YEAR2"))


```

plotting function
```{r fig.height=4.25, fig.width=8.5}
plotIAG <- function(df,y.var){
 p <-  ggplot(df, aes(x = as.integer(as.character(YEAR2)), y = y.var, group = BURN2, color = BURN2) ) + 
		geom_line(position = position_dodge(0.2))+
		geom_point(size = 3.2, position = position_dodge(0.2)) + # Add points
  geom_errorbar(aes(ymin = y.var - se, ymax = y.var + se), width = .5, alpha = 0.5, size = 1, position = position_dodge(0.2))+
		labs(x = NULL, y = "Mean cover(%)") + # Label axes
		theme_bw(base_size = 15) + # Make black and white,
								# increase base text size
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
	
	scale_color_manual(values = c("#52796f", "#dda15e", "#bc6c25"))+
  theme(legend.title = element_blank()) +
  geom_vline(xintercept = 2017, colour = "dark grey", lty = 2)+
  ylim(min = 0, max = 35)

 return(p)
}
```

combine plots
```{r fig.height=4, fig.width=9}

rawvd <- plotIAG(vdsum, vdsum$VEDU_perc) + ggtitle(expression(italic("V. dubia"))) +  theme(legend.position = "bottom")

rawbt <- plotIAG(btsum, btsum$BRTE_perc) + ggtitle(expression(italic("B. tectorum"))) + theme(legend.position = "NULL") + ylab("")

rawbj <- plotIAG(bjsum, bjsum$BRJA_perc) + ggtitle(expression(italic("B. arvensis"))) + theme(legend.position = "NULL") + ylab("")
```

```{r}
legend <- get_legend(rawvd)

rawvd <- rawvd + theme(legend.position="none") 

rawplots <- ggarrange(rawvd, rawbt, rawbj, vcontrast, btcontrast, bjcontrast, ncol = 3, nrow = 2, common.legend = TRUE, legend="bottom")

rawplots

# ggsave("annual_Grass_cover_through_time_raw.svg")
# ggsave("annual_Grass_cover_through_time_raw.png")
```

